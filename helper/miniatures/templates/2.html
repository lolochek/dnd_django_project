{% extends 'base.html' %}

{% block page_content %}
<div class="container mt-4">
    <h2 class="mb-3">Миниатюрки</h2>

    <div class="d-flex">
        <div class="me-4">
            <label for="sizeSelect" class="form-label">Выберите размер модели:</label>
            <select id="sizeSelect" class="form-select mb-3" onchange="updateGrid()">
                <option value="small">Маленький</option>
                <option value="medium">Средний</option>
                <option value="large">Большой</option>
                <option value="giant">Гигантский</option>
            </select>

            <input type="file" id="imageUpload" class="form-control mb-2" accept="image/*" multiple onchange="addImagesToCells()">
            <label for="colorPicker" class="form-label">Цвет подставки:</label>
            <input type="color" id="colorPicker" class="form-control mb-2" value="#000000" onchange="updateBaseColor()">
            <button class="btn btn-primary w-100" onclick="exportToPDF()">Экспорт в PDF</button>
        </div>

        <div id="canvasContainer" class="border" style="width: 210mm; height: 297mm; position: relative; background: white; overflow: hidden;">
            <div id="gridContainer" class="position-absolute" style="width: 100%; height: 100%; display: flex; flex-wrap: wrap; align-items: center; justify-content: center;">
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script>
    const { jsPDF } = window.jspdf;

    const gridConfig = {
        small: { cols: 5, rows: 7, size: 25 },
        medium: { cols: 4, rows: 5, size: 25 },
        large: { cols: 3, rows: 4, size: 50 },
        giant: { cols: 2, rows: 3, size: 75 }
    };

    function updateGrid() {
        const size = document.getElementById('sizeSelect').value;
        const { cols, rows, size: cellSize } = gridConfig[size];
        const gridContainer = document.getElementById('gridContainer');

        gridContainer.innerHTML = '';

        for (let i = 0; i < rows * cols; i++) {
            let wrapper = document.createElement('div');
            wrapper.classList.add('position-relative', 'm-1');
            wrapper.style.width = `${210 / cols}mm`;
            wrapper.style.height = `${297 / rows}mm`;
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.alignItems = 'center';
            wrapper.style.justifyContent = 'flex-end';

            // Ножки
            let legLeft = document.createElement('div');
            legLeft.style.width = '10%';
            legLeft.style.height = '20%';
            legLeft.style.backgroundColor = 'black';
            legLeft.style.borderRadius = '50% 0 0 50%';
            legLeft.style.position = 'absolute';
            legLeft.style.bottom = '0';
            legLeft.style.left = '0';

            let legRight = legLeft.cloneNode();
            legRight.style.left = 'auto';
            legRight.style.right = '0';
            legRight.style.borderRadius = '0 50% 50% 0';

            // Полукруги
            let semicircle = document.createElement('div');
            semicircle.style.width = `${cellSize}%`;
            semicircle.style.height = `${cellSize / 2}%`;
            semicircle.style.border = '2px solid black';
            semicircle.style.borderRadius = '50% 50% 0 0';
            semicircle.style.position = 'absolute';
            semicircle.style.bottom = '20%';
            semicircle.style.left = '50%';
            semicircle.style.transform = 'translate(-50%, 0)';

            let cell = document.createElement('div');
            cell.classList.add('border', 'position-relative');
            cell.style.flexGrow = '1';
            cell.style.width = '100%';
            cell.style.height = '100%';
            cell.ondrop = drop;
            cell.ondragover = allowDrop;

            cell.appendChild(semicircle);
            wrapper.appendChild(legLeft);
            wrapper.appendChild(cell);
            wrapper.appendChild(legRight);
            gridContainer.appendChild(wrapper);
        }
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function drop(event) {
    event.preventDefault();
    const file = document.getElementById('imageUpload').files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.position = 'absolute';
        img.style.bottom = '0'; // Разворачиваем картинку вниз
        img.style.transform = 'translateY(100%)'; // Сдвигаем вниз
        img.style.zIndex = '1'; // Устанавливаем z-index, чтобы изображение было выше ножек и окружности
        event.target.appendChild(img); // Добавляем изображение в ячейку
    };
    reader.readAsDataURL(file);
}

function addImagesToCells() {
    const cells = document.querySelectorAll('#gridContainer div');
    const files = document.getElementById('imageUpload').files;
    if (!files.length) return;

    let fileIndex = 0;
    cells.forEach(cell => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.position = 'absolute';
            img.style.bottom = '0'; // Разворачиваем картинку вниз
            img.style.transform = 'translateY(100%)'; // Сдвигаем вниз
            img.style.zIndex = '1'; // Устанавливаем z-index, чтобы изображение было выше ножек и окружности
            cell.appendChild(img); // Добавляем изображение в ячейку
        };
        reader.readAsDataURL(files[fileIndex]);
        fileIndex = (fileIndex + 1) % files.length;
    });
}


    function updateBaseColor() {
        const color = document.getElementById('colorPicker').value;
        document.querySelectorAll('.base-circle').forEach(circle => {
            circle.style.borderColor = color;
        });
    }

    function exportToPDF() {
        const canvasContainer = document.getElementById('canvasContainer');

        html2canvas(canvasContainer, {
            scale: 2,
            useCORS: true
        }).then(canvas => {
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            pdf.save("miniatures.pdf");
        }).catch(err => {
            console.error("Ошибка при создании PDF:", err);
        });
    }

    updateGrid();
</script>

{% endblock %}

